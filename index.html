<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedMaster Pro v2 - Espace de R√©vision</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette Moderne */
            --primary: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #64748b; /* Slate grey */
            
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --radius: 12px;
            --font-main: 'Inter', sans-serif;
        }

        /* Dark Mode Override */
        body.dark-mode {
            --primary: #818cf8;
            --primary-hover: #6366f1;
            --primary-light: #1e1b4b;
            
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --border: #334155;
            --shadow-sm: none;
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: var(--font-main);
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- HEADER & CONTROLS --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h1::before {
            content: 'üß¨';
            font-size: 1.5rem;
        }

        .top-controls {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .top-controls { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }

        .streak-display {
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .streak-number { color: var(--warning); font-weight: 800; }

        .quick-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-main);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-danger {
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .theme-toggle:hover { background: var(--bg-input); color: var(--text-main); }

        /* --- NAVIGATION --- */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding: 5px;
            background: var(--bg-input);
            border-radius: 12px;
            width: fit-content;
        }

        .nav-tab {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-family: var(--font-main);
        }

        .nav-tab:hover { color: var(--text-main); }

        .nav-tab.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TABLE & CARDS --- */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-controls {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filter { display: flex; gap: 10px; flex: 1; flex-wrap: wrap; }

        input, select, textarea {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-main);
            font-family: var(--font-main);
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
            background: var(--bg-card);
        }

        .table-wrapper { overflow-x: auto; max-height: 70vh; }

        table { width: 100%; border-collapse: collapse; }
        
        th {
            background: var(--bg-input);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 16px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--bg-body); }

        .row-actions { display: flex; gap: 8px; }
        
        .icon-btn {
            width: 32px; height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .icon-btn:hover { border-color: var(--primary); color: var(--primary); }
        .icon-btn.success:hover { border-color: var(--success); color: var(--success); background: #ecfdf5; }
        .icon-btn.danger:hover { border-color: var(--danger); color: var(--danger); background: #fef2f2; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-not-started { background: #f3f4f6; color: #4b5563; }
        .status-learning { background: #fffbeb; color: #b45309; }
        .status-reviewing { background: #eff6ff; color: #1d4ed8; }
        .status-mastered { background: #ecfdf5; color: #047857; }
        .status-urgent { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        .difficulty-display { display: flex; gap: 4px; }
        .diff-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--border);
        }
        .diff-dot.filled { background: var(--warning); }

        /* --- DASHBOARD --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 10px 0 5px 0;
            line-height: 1;
        }

        .stat-description { font-size: 0.85rem; color: var(--text-muted); }

        .progress-section, .chart-container, .heatmap-container {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            margin-bottom: 25px;
        }

        .progress-bar-container {
            height: 12px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 200px;
            padding-top: 20px;
        }
        
        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .chart-bar {
            width: 30%;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            opacity: 0.8;
            transition: height 0.3s, opacity 0.2s;
            min-height: 4px;
        }
        
        .chart-bar:hover { opacity: 1; }
        .chart-label { font-size: 0.8rem; color: var(--text-muted); }
        .chart-value { font-size: 0.75rem; font-weight: 600; }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(52, 1fr);
            gap: 4px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background: var(--bg-input);
        }
        
        .heatmap-cell[data-level="1"] { background: #c7d2fe; }
        .heatmap-cell[data-level="2"] { background: #a5b4fc; }
        .heatmap-cell[data-level="3"] { background: #818cf8; }
        .heatmap-cell[data-level="4"] { background: #6366f1; }
        .heatmap-cell[data-level="5"] { background: #4f46e5; }

        /* --- FOCUS MODE --- */
        .timer-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 60px 20px;
            text-align: center;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .timer-display {
            font-size: 6rem;
            font-weight: 200;
            color: var(--text-main);
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
        }

        .timer-controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
        
        .timer-chapter {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 12px;
            text-align: left;
        }

        .timer-presets {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timer-preset {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .timer-preset.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* --- PLANNING --- */
        .revision-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .revision-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .revision-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .revision-card.urgent { border-left-color: var(--danger); }
        .revision-card.soon { border-left-color: var(--warning); }
        .revision-card.scheduled { border-left-color: var(--success); }

        .revision-date { font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 4px; }
        .revision-chapter { font-size: 1rem; color: var(--text-main); margin-bottom: 8px; }
        .revision-subject { font-size: 0.85rem; color: var(--text-muted); }

        /* --- MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center; justify-content: center;
        }

        .modal.show { display: flex; animation: fadeIn 0.2s; }

        .modal-content {
            background: var(--bg-card);
            width: 95%; max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 0;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .modal-title { font-size: 1.25rem; font-weight: 600; }
        
        .close-modal {
            background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer;
        }

        .modal-body { padding: 30px; }

        .form-section { margin-bottom: 25px; }
        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 5px;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 0.85rem; font-weight: 500; color: var(--text-main); }

        .difficulty-selector { display: flex; gap: 5px; }
        .diff-option {
            width: 40px; height: 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-weight: 600;
            background: var(--bg-input);
        }
        .diff-option.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .scheduler-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .schedule-option {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .schedule-option:hover { border-color: var(--primary); }
        .schedule-option.selected { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .schedule-label { font-size: 0.75rem; margin-bottom: 4px; }
        .schedule-days { font-weight: 700; }

        /* --- NOTIFICATIONS & EMPTY STATE --- */
        .alert-banner {
            background: #fff7ed;
            border: 1px solid #ffedd5;
            color: #c2410c;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .alert-banner.show { display: flex; }

        .toast {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--text-main); color: var(--bg-card);
            padding: 12px 24px; border-radius: 8px;
            box-shadow: var(--shadow-lg); z-index: 2000;
            display: flex; align-items: center; gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .confetti { position: fixed; width: 8px; height: 8px; z-index: 9999; }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Mobile adjustment */
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .nav-tabs { overflow-x: auto; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>MedMaster <span style="color: var(--primary); font-weight: 300;">Pro</span></h1>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Syst√®me de r√©vision & suivi d'apprentissage</p>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                 <div class="streak-display">
                    üî• <span class="streak-number" id="streakNumber">0</span> jours
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Changer le th√®me">üåì</button>
            </div>
        </header>

        <div class="top-controls">
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab(event, 'tracker')">Tableau</button>
                <button class="nav-tab" onclick="switchTab(event, 'dashboard')">Analytics</button>
                <button class="nav-tab" onclick="switchTab(event, 'focus')">Focus</button>
                <button class="nav-tab" onclick="switchTab(event, 'planning')">Planning</button>
                <button class="nav-tab" onclick="switchTab(event, 'settings')">R√©glages</button>
            </nav>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <span>+</span> Nouveau Chapitre
                </button>
                <button class="btn" onclick="saveData()">üíæ</button>
                <button class="btn" onclick="exportData()">üì•</button>
                <label class="btn" style="cursor: pointer;">
                    üì§
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
            </div>
        </div>

        <div class="alert-banner" id="alertBanner">
            <span style="font-size: 1.2rem;">‚ö°</span>
            <div><strong>Attention :</strong> Vous avez <span id="alertCount">0</span> r√©vision(s) pr√©vue(s) dans les prochaines 48h !</div>
        </div>

        <div class="tab-content active" id="tracker">
            <div class="table-container">
                <div class="table-controls">
                    <div class="search-filter">
                        <input type="text" style="flex: 2; min-width: 200px;" id="searchInput" placeholder="üîç Rechercher un chapitre..." oninput="filterTable()">
                        <select id="statusFilter" onchange="filterTable()">
                            <option value="">Tous les statuts</option>
                            <option value="Non commenc√©">Non commenc√©</option>
                            <option value="En apprentissage">En apprentissage</option>
                            <option value="En r√©vision">En r√©vision</option>
                            <option value="Ma√Ætris√©">Ma√Ætris√©</option>
                            <option value="Urgence">Urgence</option>
                        </select>
                        <select id="matiereFilter" onchange="filterTable()">
                            <option value="">Toutes les mati√®res</option>
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Reset</button>
                </div>
                
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üìö</div>
                    <h2 style="margin-bottom: 10px;">Aucun chapitre enregistr√©</h2>
                    <p style="margin-bottom: 20px;">Commencez par ajouter votre premier chapitre √† r√©viser</p>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span>+</span> Ajouter un chapitre
                    </button>
                </div>

                <div class="table-wrapper">
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th>UE/Mat</th>
                                <th>Chapitre</th>
                                <th>Type</th>
                                <th>Statut</th>
                                <th>Diff.</th>
                                <th>Score</th>
                                <th>Rev.</th>
                                <th>Derni√®re</th>
                                <th>Prochaine</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-content" id="dashboard">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Chapitres</div>
                    <div class="stat-value" id="totalChapters">0</div>
                    <div class="stat-description">Base de connaissances</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ma√Ætris√©s</div>
                    <div class="stat-value" id="masteredChapters" style="color: var(--success);">0</div>
                    <div class="stat-description">Assimilation compl√®te</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">En cours</div>
                    <div class="stat-value" id="inProgressChapters" style="color: var(--primary);">0</div>
                    <div class="stat-description">Apprentissage actif</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Temps total</div>
                    <div class="stat-value" id="totalTime">0h</div>
                    <div class="stat-description">Temps focus cumul√©</div>
                </div>
            </div>

            <div class="progress-section">
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <h2 class="chart-title" style="margin: 0;">Progression Globale</h2>
                    <span class="stat-value" id="globalProgress" style="font-size: 1.5rem;">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Charge de travail (7 jours)</h2>
                <div class="chart-bars" id="workloadChart"></div>
            </div>

            <div class="heatmap-container">
                <h2 class="chart-title">Activit√© (365 jours)</h2>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>
        </div>

        <div class="tab-content" id="focus">
            <div class="timer-container">
                <h2 class="chart-title">Mode Focus</h2>
                
                <div class="timer-presets">
                    <div class="timer-preset active" onclick="setTimerPreset(25)">25 min</div>
                    <div class="timer-preset" onclick="setTimerPreset(45)">45 min</div>
                    <div class="timer-preset" onclick="setTimerPreset(60)">60 min</div>
                    <div class="timer-preset" onclick="setTimerPreset(5)">5 min</div>
                </div>

                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="timer-controls">
                    <button class="btn btn-primary" style="padding: 15px 30px; font-size: 1.1rem;" onclick="startTimer()">‚ñ∂ D√©marrer</button>
                    <button class="btn" style="padding: 15px 30px; font-size: 1.1rem;" onclick="pauseTimer()">‚è∏ Pause</button>
                    <button class="btn" style="padding: 15px 30px; font-size: 1.1rem;" onclick="resetTimer()">üîÑ Reset</button>
                </div>
                <div class="timer-chapter">
                    <div class="form-group">
                        <label class="form-label">Sur quoi travaillez-vous ?</label>
                        <select style="width: 100%; padding: 12px;" id="timerChapterSelect">
                            <option value="">S√©lectionner un chapitre...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="planning">
            <h2 class="chart-title" style="margin-bottom: 20px;">R√©visions planifi√©es</h2>
            <div class="revision-list" id="revisionList"></div>
        </div>

        <div class="tab-content" id="settings">
            <div class="table-container" style="max-width: 800px; margin: 0 auto; padding: 40px;">
                <h2 class="chart-title">Param√®tres</h2>
                
                <div class="form-section">
                    <h3 class="section-title">Algorithme</h3>
                    <div class="form-group">
                        <label class="form-label">M√©thode de r√©p√©tition espac√©e</label>
                        <select id="defaultAlgorithm">
                            <option value="adaptive">Adaptative (Bas√© sur le score & difficult√©)</option>
                            <option value="fixed">Intervalles fixes (J+1, J+3, J+7...)</option>
                            <option value="custom">Personnalis√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">Pr√©f√©rences</h3>
                    <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notifEnabled" checked style="width: auto;"> 
                        <label for="notifEnabled">Activer les rappels visuels</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Enregistrer les param√®tres</button>
            </div>
        </div>

    </div>

    <div class="modal" id="chapterModal" onclick="handleModalClick(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nouveau Chapitre</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="chapterForm" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="editId">

                    <div class="form-section">
                        <h3 class="section-title">Informations</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">UE / Code</label>
                                <input type="text" id="inputUE" required placeholder="Ex: UE2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mati√®re</label>
                                <input type="text" id="inputMatiere" required placeholder="Ex: Anatomie">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Titre du Chapitre</label>
                            <input type="text" id="inputChapitre" required placeholder="Ex: Ost√©ologie du membre sup√©rieur">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Type de support</label>
                                <select id="inputType">
                                    <option value="Cours">Cours magistral</option>
                                    <option value="TD">Travaux dirig√©s</option>
                                    <option value="TP">Travaux pratiques</option>
                                    <option value="Fiche">Fiche de r√©vision</option>
                                    <option value="Cas clinique">Cas clinique</option>
                                    <option value="QCM">Entra√Ænement QCM</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Statut actuel</label>
                                <select id="inputStatut">
                                    <option value="Non commenc√©">Non commenc√©</option>
                                    <option value="En apprentissage">En apprentissage</option>
                                    <option value="En r√©vision">En r√©vision</option>
                                    <option value="Ma√Ætris√©">Ma√Ætris√©</option>
                                    <option value="Urgence">√Ä r√©viser en urgence</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">M√©triques</h3>
                        <div class="form-group">
                            <label class="form-label">Difficult√© ressentie</label>
                            <div class="difficulty-selector">
                                <div class="diff-option" data-value="1" onclick="selectDifficulty(1)">1</div>
                                <div class="diff-option" data-value="2" onclick="selectDifficulty(2)">2</div>
                                <div class="diff-option" data-value="3" onclick="selectDifficulty(3)">3</div>
                                <div class="diff-option" data-value="4" onclick="selectDifficulty(4)">4</div>
                                <div class="diff-option" data-value="5" onclick="selectDifficulty(5)">5</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Dernier Score (%)</label>
                                <input type="number" id="inputScore" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dur√©e estim√©e (min)</label>
                                <input type="number" id="inputDuree" min="0" placeholder="Temps de lecture">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Prochaine R√©vision</h3>
                        <div class="scheduler-grid">
                            <div class="schedule-option" data-schedule="J3" onclick="selectSchedule('J3')">
                                <div class="schedule-label">Rapide</div>
                                <div class="schedule-days">+3j</div>
                            </div>
                            <div class="schedule-option" data-schedule="J7" onclick="selectSchedule('J7')">
                                <div class="schedule-label">Semaine</div>
                                <div class="schedule-days">+7j</div>
                            </div>
                            <div class="schedule-option" data-schedule="J10" onclick="selectSchedule('J10')">
                                <div class="schedule-label">Standard</div>
                                <div class="schedule-days">+10j</div>
                            </div>
                            <div class="schedule-option" data-schedule="J15" onclick="selectSchedule('J15')">
                                <div class="schedule-label">Moyenne</div>
                                <div class="schedule-days">+15j</div>
                            </div>
                            <div class="schedule-option" data-schedule="J30" onclick="selectSchedule('J30')">
                                <div class="schedule-label">Longue</div>
                                <div class="schedule-days">+30j</div>
                            </div>
                            <div class="schedule-option custom" data-schedule="custom" onclick="selectSchedule('custom')">
                                <div class="schedule-label">Date</div>
                                <div class="schedule-days">üìÖ</div>
                            </div>
                        </div>
                        <div class="form-group" id="customDateGroup" style="display: none; margin-top: 15px;">
                            <label class="form-label">S√©lectionner une date</label>
                            <input type="date" id="inputCustomDate">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">Notes</h3>
                        <div class="form-group">
                            <textarea id="inputComments" placeholder="Points cl√©s √† retenir..." rows="3"></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px;">Enregistrer le chapitre</button>
                        <button type="button" class="btn" onclick="closeModal()" style="padding: 12px;">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CORE DATA STRUCTURE & STATE
        // ============================================
        let chapters = [];
        let nextId = 1;
        let currentEditId = null;
        let selectedDifficulty = 3;
        let selectedSchedule = 'J10';
        
        // Timer state
        let timerInterval = null;
        let timerInitialSeconds = 25 * 60; // Fix 6: Remember initial time
        let timerSeconds = 25 * 60;
        let timerRunning = false;
        let currentTimerChapterId = null;

        // ============================================
        // EVIDENCE-BASED SPACED REPETITION ALGORITHM
        // ============================================
        const REVISION_INTERVALS = {
            1: [1, 3, 7, 14, 30, 90, 180],      // Tr√®s facile
            2: [1, 3, 7, 14, 30, 60, 120],      // Facile
            3: [1, 3, 5, 10, 20, 40, 80],       // Moyen
            4: [1, 2, 4, 7, 14, 28, 56],        // Difficile
            5: [1, 2, 3, 5, 10, 20, 40]         // Tr√®s difficile
        };

        // Fix 15: Score-based calculation
        function calculateNextRevision(difficulty, revisionCount, score = null) {
            const intervals = REVISION_INTERVALS[difficulty] || REVISION_INTERVALS[3];
            let index = Math.min(revisionCount, intervals.length - 1);
            
            // Adjust based on score if available
            if (score !== null) {
                if (score >= 90) index = Math.min(index + 1, intervals.length - 1);
                else if (score < 60) index = Math.max(0, index - 1);
            }
            
            return intervals[index];
        }

        // ============================================
        // THEME TOGGLE
        // ============================================
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        // Fix 1: Event handling safety
        function switchTab(event, tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'planning') {
                showPlanning();
            } else if (tabName === 'focus') {
                populateTimerSelect();
            }
        }

        // ============================================
        // MODAL MANAGEMENT
        // ============================================
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Nouveau Chapitre';
            document.getElementById('chapterForm').reset();
            document.getElementById('editId').value = '';
            selectDifficulty(3);
            selectSchedule('J10');
            document.getElementById('chapterModal').classList.add('show');
        }

        function openEditModal(id) {
            currentEditId = id;
            const chapter = chapters.find(c => c.id == id);
            if (!chapter) return;

            document.getElementById('modalTitle').textContent = 'Modifier le chapitre';
            document.getElementById('editId').value = id;
            document.getElementById('inputUE').value = chapter.ue || '';
            document.getElementById('inputMatiere').value = chapter.matiere || '';
            document.getElementById('inputChapitre').value = chapter.chapitre || '';
            document.getElementById('inputType').value = chapter.type || 'Cours';
            document.getElementById('inputStatut').value = chapter.statut || 'Non commenc√©';
            document.getElementById('inputScore').value = chapter.score || '';
            document.getElementById('inputDuree').value = chapter.dureeEstimee || '';
            document.getElementById('inputComments').value = chapter.commentaires || '';
            
            selectDifficulty(chapter.difficulte || 3);
            
            document.getElementById('chapterModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('chapterModal').classList.remove('show');
        }

        // Fix 3: Handle click outside modal
        function handleModalClick(event) {
            if (event.target === document.getElementById('chapterModal')) {
                closeModal();
            }
        }

        // Fix 3: Handle Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        function selectDifficulty(level) {
            selectedDifficulty = level;
            document.querySelectorAll('.diff-option').forEach(opt => {
                opt.classList.remove('selected');
                if (parseInt(opt.dataset.value) === level) {
                    opt.classList.add('selected');
                }
            });
        }

        // Fix 2: Use dataset instead of string matching
        function selectSchedule(type) {
            selectedSchedule = type;
            document.querySelectorAll('.schedule-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.schedule === type) {
                    opt.classList.add('selected');
                }
            });
            
            if (type === 'custom') {
                document.getElementById('customDateGroup').style.display = 'block';
            } else {
                document.getElementById('customDateGroup').style.display = 'none';
            }
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const formData = {
                id: currentEditId || nextId++,
                ue: document.getElementById('inputUE').value,
                matiere: document.getElementById('inputMatiere').value,
                chapitre: document.getElementById('inputChapitre').value,
                type: document.getElementById('inputType').value,
                statut: document.getElementById('inputStatut').value,
                difficulte: selectedDifficulty,
                score: document.getElementById('inputScore').value,
                dureeEstimee: document.getElementById('inputDuree').value,
                commentaires: document.getElementById('inputComments').value,
                nbRevisions: currentEditId ? (chapters.find(c => c.id == currentEditId).nbRevisions || 0) : 0,
                derniereRevision: currentEditId ? (chapters.find(c => c.id == currentEditId).derniereRevision || '') : '',
                prochaineRevision: calculateInitialRevisionDate(),
                dureeReelle: currentEditId ? (chapters.find(c => c.id == currentEditId).dureeReelle || 0) : 0,
                revisionHistory: currentEditId ? (chapters.find(c => c.id == currentEditId).revisionHistory || []) : [],
                created: currentEditId ? (chapters.find(c => c.id == currentEditId).created) : new Date().toISOString()
            };
            
            if (currentEditId) {
                const index = chapters.findIndex(c => c.id == currentEditId);
                if (index !== -1) {
                    chapters[index] = { ...chapters[index], ...formData };
                }
            } else {
                chapters.push(formData);
            }
            
            closeModal();
            renderTable();
            saveData();
            updateMatiereFilter();
            showToast('‚úÖ Chapitre enregistr√©');
        }

        function calculateInitialRevisionDate() {
            const today = new Date();
            
            if (selectedSchedule === 'custom') {
                return document.getElementById('inputCustomDate').value;
            }
            
            const daysMap = {
                'J3': 3,
                'J7': 7,
                'J10': 10,
                'J15': 15,
                'J30': 30
            };
            
            const days = daysMap[selectedSchedule] || 10;
            const nextDate = new Date(today);
            nextDate.setDate(nextDate.getDate() + days);
            
            return nextDate.toISOString().split('T')[0];
        }

        // ============================================
        // TABLE RENDERING
        // ============================================
        // Fix 4: Check Empty State
        function checkEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.table-wrapper');
            
            if (chapters.length === 0) {
                emptyState.style.display = 'block';
                if(tableContainer) tableContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                if(tableContainer) tableContainer.style.display = 'block';
            }
        }

        // Fix 12: Auto-sort table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if (chapters.length === 0) {
                checkEmptyState();
                return;
            }
            
            // Sort by next revision date
            const sortedChapters = [...chapters].sort((a, b) => {
                if (!a.prochaineRevision) return 1;
                if (!b.prochaineRevision) return -1;
                return new Date(a.prochaineRevision) - new Date(b.prochaineRevision);
            });
            
            sortedChapters.forEach(chapter => {
                const row = createTableRow(chapter);
                tbody.appendChild(row);
            });
            
            checkRevisionAlerts();
            checkEmptyState();
        }

        // Fix 8: Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function createTableRow(chapter) {
            const tr = document.createElement('tr');
            tr.dataset.id = chapter.id;
            
            tr.innerHTML = `
                <td>
                    <div style="font-weight:600">${chapter.ue || '-'}</div>
                    <div style="font-size:0.8em; color:var(--text-muted)">${chapter.matiere || ''}</div>
                </td>
                <td><strong>${chapter.chapitre}</strong></td>
                <td><span style="background:var(--bg-input); padding:2px 8px; border-radius:4px; font-size:0.8em">${chapter.type}</span></td>
                <td>${getStatusBadge(chapter.statut)}</td>
                <td>${getDifficultyDisplay(chapter.difficulte)}</td>
                <td>${chapter.score ? chapter.score + '%' : '-'}</td>
                <td>${chapter.nbRevisions || 0}</td>
                <td style="font-size:0.85em">${formatDate(chapter.derniereRevision)}</td>
                <td style="font-size:0.85em; font-weight:500">${formatDate(chapter.prochaineRevision)}</td>
                <td>
                    <div class="row-actions">
                        <button class="icon-btn success" onclick="completeRevision(${chapter.id})" title="R√©vision termin√©e">‚úì</button>
                        <button class="icon-btn" onclick="openEditModal(${chapter.id})" title="Modifier">‚úé</button>
                        <button class="icon-btn danger" onclick="deleteChapter(${chapter.id})" title="Supprimer">‚úï</button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        function getStatusBadge(statut) {
            const statusMap = {
                'Non commenc√©': 'status-not-started',
                'En apprentissage': 'status-learning',
                'En r√©vision': 'status-reviewing',
                'Ma√Ætris√©': 'status-mastered',
                'Urgence': 'status-urgent'
            };
            
            const className = statusMap[statut] || 'status-not-started';
            return `<span class="status-badge ${className}">${statut}</span>`;
        }

        function getDifficultyDisplay(difficulty) {
            let html = '<div class="difficulty-display">';
            for (let i = 1; i <= 5; i++) {
                html += `<div class="diff-dot ${i <= difficulty ? 'filled' : ''}"></div>`;
            }
            html += '</div>';
            return html;
        }

        // ============================================
        // REVISION COMPLETION
        // ============================================
        function completeRevision(id) {
            const chapter = chapters.find(c => c.id == id);
            if (!chapter) return;
            
            const today = new Date();
            chapter.nbRevisions = (chapter.nbRevisions || 0) + 1;
            chapter.derniereRevision = today.toISOString().split('T')[0];
            
            // Fix 15: Use improved calculation
            const score = chapter.score ? parseInt(chapter.score) : null;
            const daysUntilNext = calculateNextRevision(chapter.difficulte, chapter.nbRevisions, score);
            
            const nextDate = new Date(today);
            nextDate.setDate(nextDate.getDate() + daysUntilNext);
            chapter.prochaineRevision = nextDate.toISOString().split('T')[0];
            
            // Add to revision history
            if (!chapter.revisionHistory) chapter.revisionHistory = [];
            chapter.revisionHistory.push({
                date: today.toISOString().split('T')[0],
                difficulty: chapter.difficulte,
                score: chapter.score
            });
            
            // Update status logic
            if (chapter.nbRevisions >= 3 && chapter.score >= 80) {
                chapter.statut = 'Ma√Ætris√©';
                triggerConfetti();
                showToast(`üéâ Chapitre "${chapter.chapitre}" ma√Ætris√© !`);
            } else if (chapter.statut === 'Non commenc√©') {
                chapter.statut = 'En apprentissage';
            } else if (chapter.statut === 'En apprentissage') {
                chapter.statut = 'En r√©vision';
            }
            
            renderTable();
            saveData();
            updateStreak();
            showToast(`‚úÖ R√©vision enregistr√©e ! (+${daysUntilNext}j)`);
        }

        function deleteChapter(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce chapitre ?')) return;
            
            chapters = chapters.filter(c => c.id != id);
            renderTable();
            saveData();
            updateMatiereFilter();
            showToast('üóëÔ∏è Chapitre supprim√©');
        }

        // ============================================
        // STREAK MANAGEMENT
        // ============================================
        function updateStreak() {
            const today = new Date().toISOString().split('T')[0];
            let streak = parseInt(localStorage.getItem('streak') || '0');
            let lastDate = localStorage.getItem('lastRevisionDate');
            
            if (lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (lastDate === yesterdayStr) {
                    streak++;
                } else if (lastDate !== today) {
                    streak = 1;
                }
                
                localStorage.setItem('streak', streak);
                localStorage.setItem('lastRevisionDate', today);
            }
            
            document.getElementById('streakNumber').textContent = streak;
        }

        // ============================================
        // CONFETTI ANIMATION
        // ============================================
        function triggerConfetti() {
            const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animation = `confettiFall ${Math.random() * 2 + 2}s ease-out forwards`;
                    document.body.appendChild(confetti);
                    
                    let top = -10;
                    let angle = 0;
                    const speed = Math.random() * 5 + 2;
                    const spin = Math.random() * 10 - 5;
                    
                    const fall = setInterval(() => {
                        top += speed;
                        angle += spin;
                        confetti.style.transform = `translateY(${top}px) rotate(${angle}deg)`;
                        if (top > window.innerHeight) {
                            clearInterval(fall);
                            confetti.remove();
                        }
                    }, 20);

                }, i * 20);
            }
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        // Fix 7: Improved Toast animation and queue clearing
        function showToast(message) {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animation setup
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // FILTER & SEARCH
        // ============================================
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const matiereFilter = document.getElementById('matiereFilter').value;
            
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const id = row.dataset.id;
                const chapter = chapters.find(c => c.id == id);
                if (!chapter) return;
                
                const matchesSearch = !searchTerm || 
                    chapter.chapitre.toLowerCase().includes(searchTerm) ||
                    (chapter.matiere && chapter.matiere.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || chapter.statut === statusFilter;
                const matchesMatiere = !matiereFilter || chapter.matiere === matiereFilter;
                
                row.style.display = (matchesSearch && matchesStatus && matchesMatiere) ? '' : 'none';
            });
        }

        function updateMatiereFilter() {
            const select = document.getElementById('matiereFilter');
            const matieres = [...new Set(chapters.map(c => c.matiere).filter(Boolean))].sort();
            
            select.innerHTML = '<option value="">Toutes les mati√®res</option>';
            matieres.forEach(matiere => {
                const option = document.createElement('option');
                option.value = matiere;
                option.textContent = matiere;
                select.appendChild(option);
            });
        }

        // ============================================
        // REVISION ALERTS
        // ============================================
        function checkRevisionAlerts() {
            const today = new Date();
            today.setHours(0,0,0,0); // Fix 5: Reset hours for date calc
            
            const twoDaysFromNow = new Date(today);
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);
            
            const upcomingRevisions = chapters.filter(c => {
                if (!c.prochaineRevision) return false;
                const revDate = new Date(c.prochaineRevision);
                revDate.setHours(0,0,0,0);
                return revDate <= twoDaysFromNow;
            });
            
            // Fix 11: Alert count
            const banner = document.getElementById('alertBanner');
            const alertCount = document.getElementById('alertCount');
            
            if (upcomingRevisions.length > 0) {
                alertCount.textContent = upcomingRevisions.length;
                banner.classList.add('show');
            } else {
                banner.classList.remove('show');
            }
        }

        // ============================================
        // DASHBOARD ANALYTICS
        // ============================================
        function updateDashboard() {
            document.getElementById('totalChapters').textContent = chapters.length;
            document.getElementById('masteredChapters').textContent = 
                chapters.filter(c => c.statut === 'Ma√Ætris√©').length;
            document.getElementById('inProgressChapters').textContent = 
                chapters.filter(c => c.statut === 'En apprentissage' || c.statut === 'En r√©vision').length;
            
            const totalMinutes = chapters.reduce((sum, c) => sum + (parseInt(c.dureeReelle) || 0), 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('totalTime').textContent = `${hours}h${minutes > 0 ? minutes : ''}`;
            
            const progress = chapters.length > 0 
                ? Math.round((chapters.filter(c => c.statut === 'Ma√Ætris√©').length / chapters.length) * 100)
                : 0;
            document.getElementById('globalProgress').textContent = progress + '%';
            document.getElementById('progressBarFill').style.width = progress + '%';
            
            generateWorkloadChart();
            generateHeatmap();
        }

        function generateWorkloadChart() {
            const chart = document.getElementById('workloadChart');
            chart.innerHTML = '';
            
            const today = new Date();
            const workload = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                const chaptersForDay = chapters.filter(c => c.prochaineRevision === dateStr);
                const minutes = chaptersForDay.reduce((sum, c) => sum + (parseInt(c.dureeEstimee) || 30), 0);
                
                workload.push({
                    date: dateStr,
                    minutes: minutes,
                    day: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][date.getDay()]
                });
            }
            
            const maxMinutes = Math.max(...workload.map(w => w.minutes), 1);
            
            workload.forEach(day => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-bar-wrapper';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                const height = (day.minutes / maxMinutes) * 100;
                bar.style.height = height > 0 ? height + '%' : '4px';
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = day.minutes > 0 ? day.minutes : '';
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = day.day;
                
                wrapper.appendChild(value);
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                chart.appendChild(wrapper);
            });
        }

        function generateHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            
            const today = new Date();
            const activityMap = {};
            
            chapters.forEach(chapter => {
                if (chapter.revisionHistory && chapter.revisionHistory.length > 0) {
                    chapter.revisionHistory.forEach(rev => {
                        activityMap[rev.date] = (activityMap[rev.date] || 0) + 1;
                    });
                }
            });
            
            for (let i = 52; i >= 0; i--) { 
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.title = dateStr;
                
                const count = activityMap[dateStr] || 0;
                if (count > 0) {
                    const level = Math.min(Math.ceil(count / 2), 5);
                    cell.setAttribute('data-level', level);
                }
                
                grid.appendChild(cell);
            }
        }

        // ============================================
        // PLANNING VIEW
        // ============================================
        function showPlanning() {
            const container = document.getElementById('revisionList');
            container.innerHTML = '';
            
            const upcoming = chapters
                .filter(c => c.prochaineRevision)
                .sort((a, b) => new Date(a.prochaineRevision) - new Date(b.prochaineRevision))
                .slice(0, 30);
            
            if (upcoming.length === 0) {
                container.innerHTML = '<p style="padding: 20px; color:var(--text-muted)">Aucune r√©vision planifi√©e.</p>';
                return;
            }
            
            // Fix 5: Correct date difference calculation
            const today = new Date();
            today.setHours(0,0,0,0);
            
            upcoming.forEach(chapter => {
                const revDate = new Date(chapter.prochaineRevision);
                revDate.setHours(0,0,0,0);
                const daysUntil = Math.ceil((revDate - today) / (1000 * 60 * 60 * 24));
                
                let urgencyClass = 'scheduled';
                let urgencyText = `Dans ${daysUntil} jours`;
                
                if (daysUntil < 0) {
                    urgencyClass = 'urgent';
                    urgencyText = "En retard";
                } else if (daysUntil === 0) {
                    urgencyClass = 'urgent';
                    urgencyText = "Aujourd'hui";
                } else if (daysUntil === 1) {
                    urgencyClass = 'soon';
                    urgencyText = 'Demain';
                } else if (daysUntil <= 3) {
                    urgencyClass = 'soon';
                }
                
                const card = document.createElement('div');
                card.className = `revision-card ${urgencyClass}`;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start">
                        <div>
                            <div class="revision-date">${formatDate(chapter.prochaineRevision)}</div>
                            <div class="revision-chapter">${chapter.chapitre}</div>
                            <div class="revision-subject">${chapter.matiere || 'Mati√®re inconnue'} ‚Ä¢ ${chapter.type}</div>
                        </div>
                        <div style="text-align:right">
                            <span style="font-size:0.8em; font-weight:700; color:${urgencyClass==='urgent'?'var(--danger)':urgencyClass==='soon'?'var(--warning)':'var(--success)'}">
                                ${urgencyText.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="completeRevision(${chapter.id}); showPlanning()" style="margin-top: 15px; width: 100%; justify-content:center">
                        ‚úì Marquer comme r√©vis√©
                    </button>
                `;
                
                container.appendChild(card);
            });
        }

        // ============================================
        // POMODORO TIMER
        // ============================================
        function populateTimerSelect() {
            const select = document.getElementById('timerChapterSelect');
            select.innerHTML = '<option value="">S√©lectionner un chapitre...</option>';
            
            chapters
                .filter(c => c.statut !== 'Ma√Ætris√©')
                .forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.id;
                    option.textContent = `${chapter.matiere} - ${chapter.chapitre}`;
                    select.appendChild(option);
                });
        }

        // Fix 6: Set timer preset
        function setTimerPreset(minutes) {
            document.querySelectorAll('.timer-preset').forEach(p => p.classList.remove('active'));
            // Use current event safely
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            timerSeconds = minutes * 60;
            timerInitialSeconds = minutes * 60;
            updateTimerDisplay();
        }

        function startTimer() {
            if (timerRunning) return;
            
            const select = document.getElementById('timerChapterSelect');
            if (select.value) {
                currentTimerChapterId = select.value;
            }
            
            timerRunning = true;
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    completeTimerSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
        }

        // Fix 6: Reset to initial value
        function resetTimer() {
            pauseTimer();
            timerSeconds = timerInitialSeconds;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function completeTimerSession() {
            pauseTimer();
            
            if (currentTimerChapterId) {
                const chapter = chapters.find(c => c.id == currentTimerChapterId);
                if (chapter) {
                    chapter.dureeReelle = (parseInt(chapter.dureeReelle) || 0) + (timerInitialSeconds / 60);
                    saveData();
                }
            }
            
            showToast('üéâ Session Focus termin√©e ! Pause m√©rit√©e.');
            resetTimer();
        }

        // ============================================
        // DATA PERSISTENCE
        // ============================================
        // Fix 9: Safer save
        function saveData() {
            try {
                localStorage.setItem('medMasterData', JSON.stringify(chapters));
                localStorage.setItem('medMasterNextId', nextId);
                localStorage.setItem('lastSaveDate', new Date().toISOString());
            } catch (e) {
                showToast('‚ùå Erreur de sauvegarde : ' + e.message);
                console.error('Erreur sauvegarde:', e);
            }
        }

       function loadData() {
    const saved = localStorage.getItem('medMasterData');
    if (saved) {
        try {
            chapters = JSON.parse(saved);
            
            // --- BLOC DE R√âPARATION AUTO ---
            // Force la r√©attribution d'IDs uniques √† chaque chargement
            // Cela corrige imm√©diatement tout conflit existant
            chapters.forEach((chapter, index) => {
                chapter.id = index + 1;
            });
            // Met √† jour le compteur pour le prochain ajout
            nextId = chapters.length + 1;
            // -------------------------------

            renderTable();
            updateMatiereFilter();
            updateStreak();
            
            // Sauvegarde imm√©diate de la version propre
            localStorage.setItem('medMasterData', JSON.stringify(chapters));
            localStorage.setItem('medMasterNextId', nextId);
            
        } catch (e) {
            console.error("Erreur chargement:", e);
            chapters = [];
            nextId = 1;
        }
    }
}

        function exportData() {
            const dataStr = JSON.stringify(chapters, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const fileName = 'medmaster_backup_' + new Date().toISOString().slice(0, 10) + '.json';
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', fileName);
            link.click();
            
            showToast('üì• Sauvegarde t√©l√©charg√©e');
        }

        // Fix 13: Reset file input and improved robust import
        function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // Support des diff√©rentes versions
            let importedChapters = [];
            if (Array.isArray(data)) {
                importedChapters = data;
            } else if (data.chapters) {
                importedChapters = data.chapters;
            }
            
            // √âCRASEMENT ET NETTOYAGE
            chapters = importedChapters;
            
            // R√©attribution imm√©diate d'IDs uniques pour √©viter les conflits
            chapters.forEach((c, index) => {
                c.id = index + 1;
            });
            nextId = chapters.length + 1;
            
            renderTable();
            saveData();
            updateMatiereFilter();
            showToast('‚úÖ Donn√©es import√©es et nettoy√©es');
            
        } catch (error) {
            console.error(error);
            showToast('‚ùå Erreur: Fichier invalide');
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset du champ fichier
}

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è Attention ! Tout effacer ? Cette action est irr√©versible.')) {
                return;
            }
            
            chapters = [];
            nextId = 1;
            renderTable();
            saveData();
            updateMatiereFilter();
            showToast('üóëÔ∏è Donn√©es remises √† z√©ro');
        }

        function saveSettings() {
            showToast('‚öôÔ∏è Pr√©f√©rences enregistr√©es');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Fix 10: Auto-save
        setInterval(() => {
            if(chapters.length > 0) saveData();
        }, 60000);

        // Fix 10: Protect against data loss
        window.addEventListener('beforeunload', function(e) {
            if (chapters.length > 0 && timerRunning) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadData();
            updateDashboard();
            updateStreak();
            checkRevisionAlerts();
            
            // Fix 14: Welcome message
            if (chapters.length === 0) {
                setTimeout(() => {
                    showToast('üëã Bienvenue sur MedMaster Pro v2 !');
                }, 500);
            }
        });
    </script>
</body>
</html>